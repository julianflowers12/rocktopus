---
title: "Using rocktopus"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Using rocktopus}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
execute:
  freeze: auto
params:
  description: "A vignette for using the rocktopus package to retrieve and process energy consumption data from Octopus Energy."
  start: "2025-01-01"
  property_index: 2
  frequency: "month"
---

## Using the `rocktopus` package

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

`rocktopus` is an R package designed to interact with the Octopus Energy API, allowing users to retrieve and process energy consumption data. This vignette provides a brief overview of how to set up and use the package.

To use the `rocktopus` package, you need to install it along with its dependencies. The following code snippet demonstrates how to install the package and its required libraries:

```{r setup}
# Install the rocktopus package from GitHub
if(!require("needs")) install.packages(c("needs"), repos = "https://cloud.r-project.org/")

library(needs)
needs("tidyverse", "data.table", "janitor", "lubridate", "httr", "glue", "purrr", "rlist")

devtools::install_github("julianflowers12/rocktopus", force = TRUE)
library(rocktopus)

theme_set(ggthemes::theme_economist())

```

## Setting Up Your Environment

To use the `rocktopus` package, you need to set up your Octopus Energy account and API key as environment variables. This allows the package to authenticate and access your energy consumption data securely.

You can obtain an API key from your Octopus Energy account settings. An API key can be generated by creating an Octopus developer account - <https://octopus.energy/dashboard/new/accounts/personal-details/api-access>. Once you have your account number and API key, you can set them as environment variables in your R session or in your `.Renviron` file.

```{r}
# Get your Octopus Energy account and API key from your environment variables

acct <- Sys.getenv("OCTOPUS_ACC")
api_key <- Sys.getenv("OCTOPUS_API_KEY")

```

## Retrieving Meter Details

To retrieve meter details associated with your Octopus Energy account, you can use the `get_meter_details` function from the `rocktopus` package. This function requires your account number and API key as inputs.

`get_meter_details` retrieves a list of details about your electricity and gas meters, including their unique identifiers (MPAN for electricity and MPRN for gas), meter serial numbers, and other relevant details.

```{r}
# Retrieve meter details using the get_meter_details function

meter_details <- rocktopus::get_meter_info(acct, api_key)

```

We can now extract the MPAN and meter serial number for each property associated with your account. The `get_electric_mpan` function can be used to retrieve the MPAN and serial number for a specific property index.

```{r}
# Extract MPAN and meter serial number for each property

mpan <- get_mpan_details(meter_details, property_index = params$property_index) 

```

## Getting tariff information

We can also extract a table of tariff information.

```{r, eval = TRUE}

tariffs <- get_tariff_info(api_key, acct, property_index = params$property_index)
tariffs |>
  head(10)

```



## Creating Consumption Endpoints

The next step is to create endpoints for retrieving consumption data. The `create_endpoint` function constructs a URL for accessing consumption data based on the MPAN and meter serial number.

```{r}
# Create consumption endpoints for each property

cons_url <- create_endpoint(mpan = mpan[1,3], serial = mpan[1,4])

```

## Retrieving Consumption Data

To retrieve consumption data, you can use the `get_cons` function, which takes the consumption endpoint URL as input. This function returns a tibble containing the consumption details.

```{r}

consumption_data <- get_cons(cons_url, api_key = api_key)

head(consumption_data)

```

## Processing Consumption Data

To process the retrieved consumption data, you can use the `process_consumption_data` function. This function cleans and formats the data, making it easier to analyze and visualize.

```{r}

processed_data <- process_consumption_data(consumption_data) |>
  arrange(desc(date))

head(processed_data)

```

## Trend in off peak consumption

```{r}
#| label: Trend in off peak consumption
#| fig-height: 6
#| fig-width: 6

processed_data |>
  mutate(day = lubridate::wday(date, label = TRUE),
         month = lubridate::month(date, label = TRUE),
         year = year(date), 
         sun = case_when(day == "Sun" ~ 'sun', TRUE ~ 'other')) |>
  filter(peak == "off_peak", date >= "2025-04-01") |>
  select(date, day, sun, consumption) |>
  group_by(date, day) |>
  reframe(sumconsmption = mean(consumption, na.rm = TRUE)) |>
  #left_join(ev_data, by = "date") |>
  ggplot(aes(x = date, y = sumconsmption, colour = day)) +
  #geom_point() +
  geom_smooth(method = "loess", se = FALSE, aes(lty = day), span = 0.5) +
  theme_classic()



```

## Visualizing Consumption Data

You can visualize the processed consumption data using `ggplot2`. The following code snippet demonstrates how to create a bar plot showing electricity consumption over time, categorized by peak and off-peak periods.

```{r, fig.width=6, fig.height=6}

processed_data |>
  group_by(date, peak) |>
  summarise(total = sum(consumption, na.rm = TRUE)) |>
  filter(date > "2024-08-31") |>
  ggplot(aes(x = date, y = total, colour = peak)) +
  geom_point() +
  geom_smooth(method = "gam", se = FALSE, aes(fill = peak), alpha = 0.2) +
  labs(
    title = "Electricity Consumption",
    x = "Date",
    y = "Consumption (kWh)",
    fill = "Peak"
  ) +
  scale_x_date(date_labels = "%Y-%m-%d", date_breaks = "1 month") +
  theme(axis.text.x= element_text(angle = 90, hjust = 1, size = 10),
        title = element_text(size = 14, face = "bold"),
        legend.position = "bottom", 
        plot.title.position = "plot") +
  geom_vline(xintercept = as.Date(c("2025-05-18", "2025-04-29")), linetype = "dashed", color = "black") +
  facet_wrap(~ peak, scales = "free")

off_peak <- processed_data |>
  filter(date > "2024-08-31") |>
  group_by(year = year(date), month = month(date), peak) |>
  reframe(mon_cons = sum(consumption))  |>
  pivot_wider(names_from = peak, values_from = mon_cons) |>
  mutate(summer = mean(peak[month %in% c(4:9)]), 
         winter = mean(peak[month %in% c(10:12, 1:3)]), 
         summer1 = mean(off_peak[month %in% c(4:9)]), 
         winter1 = mean(off_peak[month %in% c(10:12, 1:3)]),
         period = lubridate::my(paste0(month,"-", year))) |>
  ggplot(aes(x = period, y = off_peak)) +
  geom_point() +
  geom_smooth(method = "gam", se = FALSE, alpha = 0.2) +
  geom_line(aes(y = summer1), colour = "red") +
  geom_line(aes(y = winter1), colour = "blue") +
  labs(
    title = "Electricity Consumption",
    x = "Date",
    y = "Consumption (kWh)",
    fill = "Peak"
  ) +
  scale_x_date(date_labels = "%Y-%m-%d", date_breaks = "1 month") +
  theme(axis.text.x= element_text(angle = 90, hjust = 1, size = 10),
        title = element_text(size = 14, face = "bold"),
        legend.position = "bottom", 
        plot.title.position = "plot") +
  geom_vline(xintercept = as.Date(c("2025-05-18", "2025-04-29")), linetype = "dashed", color = "black")

peak <- processed_data |>
  filter(date > "2024-08-31") |>
  group_by(year = year(date), month = month(date), peak) |>
  reframe(mon_cons = sum(consumption))  |>
  pivot_wider(names_from = peak, values_from = mon_cons) |>
  mutate(summer = mean(peak[month %in% c(4:9)]), 
         winter = mean(peak[month %in% c(10:12, 1:3)]), 
         summer1 = mean(off_peak[month %in% c(4:9)]), 
         winter1 = mean(off_peak[month %in% c(10:12, 1:3)]),
         period = lubridate::my(paste0(month,"-", year))) |>
  ggplot(aes(x = period, y = peak)) +
  geom_point() +
  geom_smooth(method = "gam", se = FALSE, aes(fill = peak), alpha = 0.2) +
  geom_line(aes(y = summer), colour = "red") +
  geom_line(aes(y = winter), colour = "blue") +
  labs(
    title = "Electricity Consumption",
    x = "Date",
    y = "Consumption (kWh)",
    fill = "Peak"
  ) +
  scale_x_date(date_labels = "%Y-%m-%d", date_breaks = "1 month") +
  theme(axis.text.x= element_text(angle = 90, hjust = 1, size = 10),
        title = element_text(size = 14, face = "bold"),
        legend.position = "bottom", 
        plot.title.position = "plot") +
  geom_vline(xintercept = as.Date(c("2025-05-18", "2025-04-29")), linetype = "dashed", color = "black")

library(patchwork)


off_peak + peak + plot_layout(ncol = 1)


```

## Getting aggregated consumption data

### Weekly exported KWh

```{r}
#| label: Create aggregated consumption endpoints for each property
#| fig-height: 6
#| fig-width: 6
#| eval: FALSE

library(rocktopus)
agg_url <- create_endpoint_agg(mpan = mpan[2,3], serial = mpan[2,4], group_by = "month")

t <- get_cons(agg_url, api_key)

octo_request <- function(url, api_key) {
  httr2::request(url) |>
    httr2::req_auth_basic(username = api_key, password = "") |>
    httr2::req_headers(
      "User-Agent" = sprintf(
        "rocktopus/%s (R httr2; https://github.com/julianflowers12/rocktopus)",
        utils::packageVersion("rocktopus")
      )
    )
}


resp <- octo_request(agg_url, api_key = Sys.getenv("OCTOPUS_API_KEY")) |>
        httr2::req_perform() |>
        httr2::resp_body_json()

response <- resp |>
        tibble::enframe() |>
        dplyr::filter(name == "results") |>
        tidyr::unnest(value) |>
        tidyr::unnest_auto(value)

export <- get_cons(agg_url, api_key)

octo_request(agg_url, api_key)

agg_consumption_data <- get_cons(agg_url, api_key = api_key) 
  mutate(date_start = ymd(str_sub(interval_start, 1, 10)))

which.max(agg_consumption_data$consumption)

agg_consumption_data |>
  select(date_start, export = consumption) |>
  filter(date_start > params$start) |>
  ggplot(aes(x = date_start, y = export)) +
  geom_col() +
  geom_smooth(method = "loess", lty= "dashed", colour = "red", se = FALSE) +
  scale_x_date(date_labels = "%Y-%m", date_breaks = "1 month") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 10),
        title = element_text(size = 14, face = "bold"),
        legend.position = "bottom", 
        plot.title.position = "plot") +
    ggtitle(glue::glue("Solar export by ", {params$frequency}))

```
